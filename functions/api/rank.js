const TABLE="ANALYTICS",LIMIT=200,BASE_HEADERS={"content-type":"application/json; charset=utf-8","cache-control":"no-store"};function corsHeaders(){return{"access-control-allow-origin":"*","access-control-allow-methods":"GET, OPTIONS","access-control-allow-headers":"content-type, x-requested-with"}}function jsonResponse(e,t=200){return new Response(JSON.stringify(e),{status:t,headers:{...BASE_HEADERS,...corsHeaders()}})}function getSqlApiConfig(e){const t=e.AE_ACCOUNT_ID||"",r=e.AE_API_TOKEN||"";return t&&r?{accountId:t,apiToken:r}:null}async function runSqlApi(e,t){const r=getSqlApiConfig(e);if(!r)throw new Error("Missing Analytics Engine SQL API credentials.");const n=`https://api.cloudflare.com/client/v4/accounts/${r.accountId}/analytics_engine/sql`,a=await fetch(n,{method:"POST",headers:{authorization:`Bearer ${r.apiToken}`,"content-type":"text/plain; charset=utf-8"},body:t});if(!a.ok){const e=await a.text();throw new Error(`Analytics Engine SQL API failed (${a.status}): ${e}`)}let o;try{o=await a.json()}catch(e){const t=await a.text();throw new Error(`Analytics Engine SQL API invalid response: ${t}`)}if(o&&!1===o.success){const e=o.errors&&o.errors.length?o.errors[0].message:"Analytics Engine SQL API error";throw new Error(e)}return o.result||o}function normalizePath(e){let t=(e||"").trim();if(!t)return"/";try{t=encodeURI(decodeURI(t))}catch(e){t=encodeURI(t)}t.startsWith("/")||(t=`/${t}`),t=t.replace(/\/{2,}/g,"/");const r=/\.[a-zA-Z0-9]+$/.test(t);return"/"===t||r||t.endsWith("/")||(t+="/"),t}const ROLLING_DAY_MS=864e5,ROLLING_WEEK_MS=6048e5,ROLLING_MONTH_MS=2592e6,PATH_WHERE="blob2 IS NOT NULL AND blob2 != ''";function unwrapRows(e){return e?Array.isArray(e)?e:Array.isArray(e.result)?e.result:e.result&&Array.isArray(e.result.data)?e.result.data:Array.isArray(e.results)?e.results:Array.isArray(e.data)?e.data:Array.isArray(e.rows)?e.rows:[]:[]}function getNumber(e,t){const r=e&&e.length?e[0]:null;if(!r)return 0;const n=t in r?r[t]:r[Object.keys(r)[0]],a=Number(n);return Number.isFinite(a)?a:0}async function queryNumber(e,t,r,n=0){try{return getNumber(unwrapRows(await runSqlApi(e,t)),r)}catch(e){return n}}async function queryRows(e,t){try{return unwrapRows(await runSqlApi(e,t))}catch(e){return[]}}function normalizePages(e){return(e||[]).map(e=>({path:normalizePath(e.path||""),pv:Number(e.pv)||0})).filter(e=>e.path&&"/"!==e.path)}function formatUtcDate(e){return e.toISOString().slice(0,19).replace("T"," ")}export async function onRequestGet({env:e}){const t=new Date,r=new Date(t.getTime()-864e5),n=new Date(t.getTime()-6048e5),a=new Date(t.getTime()-2592e6),o=`timestamp >= toDateTime('${formatUtcDate(r)}')`,s=`timestamp >= toDateTime('${formatUtcDate(n)}')`,i=`timestamp >= toDateTime('${formatUtcDate(a)}')`,[u,c,E,l,A,p,R,S]=await Promise.all([queryNumber(e,`SELECT SUM(double1) AS pv FROM ${TABLE} WHERE ${PATH_WHERE}`,"pv",0),queryNumber(e,`SELECT SUM(double1) AS pv FROM ${TABLE} WHERE ${i} AND ${PATH_WHERE}`,"pv",0),queryNumber(e,`SELECT SUM(double1) AS pv FROM ${TABLE} WHERE ${s} AND ${PATH_WHERE}`,"pv",0),queryNumber(e,`SELECT SUM(double1) AS pv FROM ${TABLE} WHERE ${o} AND ${PATH_WHERE}`,"pv",0),queryRows(e,`SELECT blob2 AS path, SUM(double1) AS pv FROM ${TABLE} WHERE ${PATH_WHERE} GROUP BY blob2 ORDER BY pv DESC LIMIT 200`),queryRows(e,`SELECT blob2 AS path, SUM(double1) AS pv FROM ${TABLE} WHERE ${i} AND ${PATH_WHERE} GROUP BY blob2 ORDER BY pv DESC LIMIT 200`),queryRows(e,`SELECT blob2 AS path, SUM(double1) AS pv FROM ${TABLE} WHERE ${s} AND ${PATH_WHERE} GROUP BY blob2 ORDER BY pv DESC LIMIT 200`),queryRows(e,`SELECT blob2 AS path, SUM(double1) AS pv FROM ${TABLE} WHERE ${o} AND ${PATH_WHERE} GROUP BY blob2 ORDER BY pv DESC LIMIT 200`)]);return jsonResponse({summary:{total:u,month:c,week:E,day:l},pages:{total:normalizePages(A),month:normalizePages(p),week:normalizePages(R),day:normalizePages(S)},updatedAt:(new Date).toISOString()})}export async function onRequestOptions(){return new Response(null,{status:204,headers:{...corsHeaders()}})}