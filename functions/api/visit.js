const TABLE="ANALYTICS",PATH_WHERE="blob2 IS NOT NULL AND blob2 != ''",BASE_HEADERS={"content-type":"application/json; charset=utf-8","cache-control":"no-store"};function corsHeaders(){return{"access-control-allow-origin":"*","access-control-allow-methods":"GET, OPTIONS","access-control-allow-headers":"content-type, x-requested-with"}}function jsonResponse(e,t=200){return new Response(JSON.stringify(e),{status:t,headers:{...BASE_HEADERS,...corsHeaders()}})}function getSqlApiConfig(e){const t=e.AE_ACCOUNT_ID||"",r=e.AE_API_TOKEN||"";return t&&r?{accountId:t,apiToken:r}:null}function formatSqlValue(e){return null==e?"NULL":"number"==typeof e&&Number.isFinite(e)?String(e):`'${String(e).replace(/'/g,"''")}'`}function formatSqlWithParams(e,t=[]){if(!t.length)return e;let r=0;return e.replace(/\?/g,()=>formatSqlValue(t[r++]))}async function runSqlApi(e,t,r=[]){const n=getSqlApiConfig(e);if(!n)throw new Error("Missing Analytics Engine SQL API credentials.");const a=`https://api.cloudflare.com/client/v4/accounts/${n.accountId}/analytics_engine/sql`,s=formatSqlWithParams(t,r),o=await fetch(a,{method:"POST",headers:{authorization:`Bearer ${n.apiToken}`,"content-type":"text/plain; charset=utf-8"},body:s});if(!o.ok){const e=await o.text();throw new Error(`Analytics Engine SQL API failed (${o.status}): ${e}`)}let i;try{i=await o.json()}catch(e){const t=await o.text();throw new Error(`Analytics Engine SQL API invalid response: ${t}`)}if(i&&!1===i.success){const e=i.errors&&i.errors.length?i.errors[0].message:"Analytics Engine SQL API error";throw new Error(e)}return i.result||i}function normalizePath(e){let t=(e||"").trim();if(!t)return"/";try{t=encodeURI(decodeURI(t))}catch(e){t=encodeURI(t)}t.startsWith("/")||(t=`/${t}`),t=t.replace(/\/{2,}/g,"/");const r=/\.[a-zA-Z0-9]+$/.test(t);return"/"===t||r||t.endsWith("/")||(t+="/"),t}function resolvePath(e,t){const r=(e||"").trim();if(!r)return"/";let n=r;for(let e=0;e<2;e++)try{const e=decodeURIComponent(n);if(e===n)break;n=e}catch(e){break}try{return/^https?:\/\//i.test(n)?new URL(n).pathname||"/":n.startsWith("/")?n:new URL(n,t).pathname||"/"}catch(e){return"/"}}async function sha256Hex(e){const t=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",t);return[...new Uint8Array(r)].map(e=>e.toString(16).padStart(2,"0")).join("")}async function getVisitorId(e){const t=e.headers.get("cf-connecting-ip")||"",r=e.headers.get("user-agent")||"";return t||r?sha256Hex(`${t}|${r}`):"anonymous"}function unwrapRows(e){return e?Array.isArray(e)?e:Array.isArray(e.result)?e.result:e.result&&Array.isArray(e.result.data)?e.result.data:Array.isArray(e.results)?e.results:Array.isArray(e.data)?e.data:Array.isArray(e.rows)?e.rows:[]:[]}function getNumber(e,t){const r=e&&e.length?e[0]:null;if(!r)return 0;const n=t in r?r[t]:r[Object.keys(r)[0]],a=Number(n);return Number.isFinite(a)?a:0}async function queryNumber(e,t,r,n,a=0){try{return getNumber(unwrapRows(await runSqlApi(e,t,r)),n)}catch(e){return a}}async function recordPageView(e,t,r,n){try{await e.ANALYTICS.writeDataPoint({indexes:[t],blobs:[n,r],doubles:[1]})}catch(e){}}export async function onRequestGet({request:e,env:t}){if(!t.ANALYTICS)return jsonResponse({error:"Missing ANALYTICS binding."},500);const r=normalizePath(resolvePath(new URL(e.url).searchParams.get("page")||"",e.url)),n=await getVisitorId(e),a=await sha256Hex(r);await recordPageView(t,a,r,n);const[s,o]=await Promise.all([queryNumber(t,`SELECT SUM(double1) AS pv FROM ${TABLE} WHERE index1 = ?`,[a],"pv",0),queryNumber(t,`SELECT SUM(double1) AS pv FROM ${TABLE} WHERE ${PATH_WHERE}`,[],"pv",0)]);return jsonResponse({page_pv:s,site_pv:o,site_uv:await queryNumber(t,`SELECT COUNT(DISTINCT blob1) AS uv FROM ${TABLE} WHERE ${PATH_WHERE}`,[],"uv",o)})}export async function onRequestOptions(){return new Response(null,{status:204,headers:{...corsHeaders()}})}